/* @preserve version 2.4.3 */
!function(){"use strict";const t=t=>t.notification&&t.notification.data&&"PUSH_JS_WINDOW"===t.notification.data._source;function e(t){return t}const n={host:"https://api.tinkoff.ru/v1/",subscribe:"register_for_push_notification",unsubscribe:"",status:"set_push_notification_status",store:"store",log:"log",fetchRequestInit:{}};var i=new class{db;storeName;constructor({appKey:t}={}){this.storeName="tinkoff-push"+(t?`--${t}`:""),this.db=null}async get(t){let e;return await this._withStore("readonly",(n=>{e=n.get(t)})),e.result}async set(t,e){await this._withStore("readwrite",(n=>{n.put(e,t)}))}_getDB(){return this.db||(this.db=new Promise(((t,e)=>{const n=indexedDB.open(this.storeName,1);n.onerror=()=>e(n.error),n.onupgradeneeded=()=>n.result.createObjectStore("keyval"),n.onsuccess=()=>t(n.result)}))),this.db}async _withStore(t,e){const n=await this._getDB();return new Promise(((i,o)=>{const s=n.transaction("keyval",t);s.oncomplete=()=>i(),s.onerror=()=>o(s.error),e(s.objectStore("keyval"))}))}}({appKey:self._appKey});const o=()=>i.get("api").catch(e).then((t=>({...n,...t})));function s(t,e=encodeURIComponent){return`?${Object.entries(t).map((([t,n])=>`${e(t)}=${e(n)}`)).join("&")}`}const a=(t,e)=>e?o().then((n=>fetch(n.host+n.status+s({status:t,messageId:e}),n.fetchRequestInit))):Promise.resolve(),r=()=>["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform),c=(t,n)=>async a=>{try{let r=[],c=null;a&&a instanceof Error&&(c=a.message,r=(t=>t&&t.stack&&t.stack.split&&t.stack.split("\n")||["No stack"])(a));const l=await o(),u=await i.get("settings").catch(e);l.swLog?await fetch(l.swLog,{method:"POST",body:JSON.stringify({level:a?"ERROR":"INFO",event:t,wuid:u.wuid,error:c||void 0,stack:r?.length?r:void 0,additional:n}),headers:{"Content-Type":"application/json"}}):await fetch(l.host+l.log+s({level:a?"ERROR":"INFO",component:"platformServiceWorker",message:JSON.stringify({error:c,stack:r,data:{source:t,...n}})}),l.fetchRequestInit)}catch{}return Promise.resolve()},l=(u=c,function(){return r()?u.apply(null,arguments):()=>Promise.resolve()});var u;const h=({notification:t})=>{const{RedirectURL:e=`${self.location.origin}/`}=t.data||{};return t.close(),a("read",t.tag),e?async function(t){const e=(await clients.matchAll({type:"window",includeUncontrolled:!0})).find((e=>e.url===t&&"focus"in e));return e?e.focus():clients.openWindow(t)}(e).catch(c("notification-click")):Promise.resolve()},f=({notification:t})=>a("close",t.tag);function d(t=10,e=""){const n=Math.random().toString(36).slice(2);return n.length>=10?e+n:d(t,e)}async function p(t){try{const e={source:"PUSH_JS_SW",messageId:d(),data:t},n=(t=>e=>new Promise(((n,i)=>{const o=new MessageChannel;o.port1.onmessage=t=>{t.data.error?i(t.data.error):n(t.data)},e.postMessage(`${t}`,[o.port2])})))(JSON.stringify(e)),i=[],o=await clients.matchAll({includeUncontrolled:!0});return o.forEach((t=>{i.push(n(t))})),l("notifyAll",{length:o.length})(),Promise.all(i)}catch(t){return l("notifyAll-error")(t),Promise.resolve([])}}const g=(t,e)=>p({tag:t,eventName:e}),w=({notification:t})=>g(t.tag,"close");async function y(t){if(!t.data.focusOnClick)return;const[e]=await clients.matchAll({type:"window",includeUncontrolled:!0});return e?e.focus():void 0}async function m(t){if(t.data.closeOnClick)return t.close()}const S=({notification:t})=>Promise.all([g(t.tag,"click"),y(t),m(t)]),v="actionLink",b=["actionContinue","actionLogout","actionChatSuggestAccept","actionChatSuggestDecline"];const P=({action:t,notification:e})=>{const n=-1!==b.indexOf(t)?t:v,r=[m(e)];return n===v?r.push(async function(){const{wuid:t}=await i.get("settings");return t}().then((n=>((t,e)=>t?o().then((n=>fetch(n.host+n.store+s({group:t,...e}),n.fetchRequestInit))):Promise.resolve())("id-graph",{action:t,wuid:n,webpushId:e.tag}))),a("read",e.tag)):r.push(g(e.tag,n)),Promise.all(r).then((()=>n===v?clients.openWindow(t):y(e)))},k={title:"Tinkoff.ru",lang:"RU",body:"",icon:"https://www.tinkoff.ru/apple-touch-icon-180x180.png",requireInteraction:!0};function I(t){return t?btoa(String.fromCharCode.apply(null,new Uint8Array(t))):null}function N(){const t=-1*(new Date).getTimezoneOffset();return`${e=t,e<0?"-":"+"}${(t=>{const e=Math.floor(Math.abs(t/60));return e>9?e.toString():`0${e.toString()}`})(t)}:${(t=>{const e=Math.abs(t%60);return e>9?e.toString():`0${e.toString()}`})(t)}`;var e}async function O(t){const e=await i.get("subscription"),n=await i.get("settings");if(l("saveSubscription init",{oldSubId:e,newSubId:n.endpoint,equal:e===t.endpoint})(),e===t.endpoint)return;const a=await o(),r=I(t.getKey("auth")),c=I(t.getKey("p256dh")),u={...n,newNotificationId:t.endpoint,oldNotificationId:e,publicKey:c,timezone:N(),auth:r};return await i.set("subscription",t.endpoint),await i.set("settings",u),l("saveSubscription request",{newSettings:u})(),fetch(a.host+a.subscribe+s(function(t,e){const n={},i={};let o=0;const s=t.length;for(;o<s;)i[t[o]]=1,o+=1;for(const t in e)Object.prototype.hasOwnProperty.call(i,t)||(n[t]=e[t]);return n}(["safari","applicationServerKey"],u)),a.fetchRequestInit)}const _=()=>(async()=>{const{applicationServerKey:t}=await i.get("settings");return l("createNewSubscription")(),self.registration.pushManager.subscribe({applicationServerKey:t,userVisibleOnly:!0})})().then(O).catch(c("subscription-change"));self._appKey=new URL(self.location.href).searchParams.get("webPushAppKey")??void 0;self.addEventListener("install",(()=>{self.skipWaiting()})),self.addEventListener("push",(t=>{try{const e=Date.now();t.waitUntil((async t=>{let e;l("pushDefault-received-push")();try{e=t.data?t.data.json():{}}catch(t){c("push-data-error")(t),e={}}const{notification:n={},data:i={}}=e,o={...k,...n,tag:i.messageId,data:i},s=o.title||"";l("pushDefault-push-info",{timeout:n.timeout??"empty",messageId:i.messageId})();try{await self.registration.showNotification(s,o).then((async()=>{await a("delivered",i.messageId),l("pushDefaultDelivered")()})).then((()=>self.registration.getNotifications({tag:i.messageId}))).then((t=>{const e=t[0];n.timeout&&setTimeout((()=>e.close()),n.timeout)})).catch(c("showNotification-promise-error"))}catch(t){let e="unknown",n="unknown",i="unknown",o="unknown";try{e=self.registration.pushManager?await(self.registration.pushManager?.permissionState())||"noPermissionState":"noPushManager"}catch{}try{n=self.registration.active?.state||"noActiveState"}catch{}try{i=self.registration.waiting?"true":"false"}catch{}try{o=self.serviceWorker.state||"noState"}catch{}await l("showNotification-error",{permission:e,activeSWStatus:n,hasWaitingSW:i,currentSWStatus:o})(t)}try{await p(e)}catch{}})(t)),t.waitUntil(l("pushListenerPerf",{duration:Date.now()-e})())}catch(e){t.waitUntil(l("pushListenerError")(e))}})),self.addEventListener("notificationclick",(e=>{let n;n=e.action?P:t(e)?S:h,e.waitUntil(n(e))})),self.addEventListener("notificationclose",(e=>{let n;if(!0===t(e))n=w;else n=f;e.waitUntil(n(e))})),self.addEventListener("pushsubscriptionchange",(t=>{l("pushsubscriptionchange")(),t.waitUntil(_())}))}();
